#!/bb/ash
. /etc/init.d/tc-functions
BUILD=`getBuild`

PATH="/bb:/bin:/sbin:/usr/bin:/usr/sbin"
export PATH
PORT="$(cat /usr/share/doc/tc/release.txt | cut -f1 -d:)"
VERSION="$(cat /usr/share/doc/tc/release.txt | cut -f2 -d:)"
RESULTS="$PORT:$VERSION"

if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	echo
	echo "${YELLOW}version - confirm dCore version, check for release or release candidate (RC)"
        echo "          updates, if dCore update available prompted to download, manually"
        echo "          copy into desired boot directory, reboot to complete upgrade.${NORMAL}"
	echo
	echo "Usage:"
	echo
	echo "${YELLOW}'"version"'${NORMAL}     list running dCore name and version."
	echo "${YELLOW}'"version -c"'${NORMAL}  check if running the latest stable release, if different"
        echo "              version available prompted to download, wget latest"
        echo "              stable release and md5.txt file to /tmp/release/."
	echo "${YELLOW}'"version -r"'${NORMAL}  check if running the latest release candidate, if updated"
        echo "              version available prompted to download, wget latest release"
        echo "              candidate and md5.txt file to /tmp/release_candidate/."
	echo "${YELLOW}'"version -l"'${NORMAL}  list running dCore name and version."
	echo "${YELLOW}'"version -s"'${NORMAL}  see dCore version only."
	echo
exit 1
fi




while getopts rcls OPTION
do
  case ${OPTION} in
    r) LATEST=`wget -q -O - $(cat /opt/tcemirror)/dCore/"$BUILD"/release_candidates/"$PORT"/"$PORT".latest 2>/dev/null`
       if [ "$?" == 0 ]; then
       		RUNNING="${RESULTS##*:}"
       		if [ "$LATEST" != "$RESULTS" ]; then
       			echo "Warning:"
       			echo "You are running:                    "$RESULTS""
       			echo "The latest release candidate is:    $LATEST"
                        echo " "
                        echo -n "Press Enter to download latest release candidate, (q)uit to exit: "
                        read TARGET
                        if [ "$TARGET" == "Q" ] || [ "$TARGET" == "q" ]; then
				exit
                        else
				rm -rf /tmp/release_candidate
				mkdir -p /tmp/release_candidate
                        	cd /tmp/release_candidate
                        	echo " "
                        	wget -c $(cat /opt/tcemirror)/dCore/"$BUILD"/release_candidates/"$PORT"/"$PORT".gz.md5.txt
                        	echo
                        	wget -c $(cat /opt/tcemirror)/dCore/"$BUILD"/release_candidates/"$PORT"/"$PORT".gz
				echo " "
                        	echo "Downloaded:   /tmp/release_candidate/"$PORT".gz.md5.txt"
                        	echo "              /tmp/release_candidate/"$PORT".gz"
                        	echo " "
                        	echo "Manually copy /tmp/release_candidate/"$PORT".gz to boot directory,"
                        	echo "recommend backing up old version, reboot to complete update."
 	                fi                      
                
		else
			echo "You are running "$RESULTS", the latest release candidate."
       		fi
       fi
       exit
       ;;
     c) LATEST=`wget -q -O - $(cat /opt/tcemirror)/dCore/"$BUILD"/release/"$PORT"/"$PORT".latest 2>/dev/null`
       if [ "$?" == 0 ]; then
       		RUNNING="${RESULTS##*:}"
       		if [ "$LATEST" != "$RESULTS" ]; then
       			echo "Warning:"
       			echo "You are running:          "$RESULTS""
       			echo "The latest release is:    $LATEST"
                        echo " "
			echo "Press Enter To download latest stable release, (q)uit to exit. To check for"
                        echo -n "the latest release candidate instead, exit and run 'version -r': "
                        read TARGET
                        if [ "$TARGET" = "Q" ] || [ "$TARGET" = "q" ]; then
				exit
                        else
				rm -rf /tmp/release
                        	mkdir -p /tmp/release
                        	cd /tmp/release
                        	echo " "
                        	wget -c $(cat /opt/tcemirror)/dCore/"$BUILD"/release/"$PORT"/"$PORT".gz.md5.txt
                        	echo " "
                        	wget -c $(cat /opt/tcemirror)/dCore/"$BUILD"/release/"$PORT"/"$PORT".gz
				echo " "
                        	echo "Downloaded:   /tmp/release/"$PORT".gz.md5.txt"
                        	echo "              /tmp/release/"$PORT".gz"
                        	echo " "
                        	echo "Manually copy /tmp/release/"$PORT".gz to boot directory, recommend"
                        	echo "backing up old version, reboot to complete update."
 	                fi
		else
			echo "You are running "$RESULTS", the latest release."
                fi
       fi
       exit
       ;;
    l) echo "$RESULTS"
        exit
        ;;
    s) echo "${RESULTS##*:}"
        exit
        ;;
    *) echo "Run  version --help  for usage information." ;;
  esac
done
echo "$RESULTS"
exit